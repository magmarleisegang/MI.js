function CalculateTotal()
{
    var n = 0;
    $("#grdSubscriptions tbody tr[id] td.sub-price").each(function()
    {
        n += parseFloat(this.innerHTML)
    }),
    $("tr.renew-grid-foorter td span.total").text(n.toFixed(2)),
    n > 0 ? $("#divPayment, #btnPay").show() : $("#divPayment, #btnPay").hide(),
    $("#grdSubscriptions tbody tr[id] td.sub-types select option:selected:contains(*)").length > 0 ? $("#pMultiplePeriods").addClass("pro") : $("#pMultiplePeriods").removeClass("pro")
}
function GetRowObj(n)
{
    var t = n.children("td.sub-types").children("select"),
        i;
    return t = t.children("option[value=" + t.val() + "]"), i = {
            ID: t.val(), Name: t.text(), Price: parseFloat(t.data("p")).toFixed(2), Expiry: t.data("e")
        }, n.Obj = {
                ID: n.attr("id"), Device: n.children("td.sort-selector").text(), CurExp: n.children("td.sub-exp").text(), Option: i
            }, n
}
$(document).ready(function()
{
    renewTemplate = $("#divAutoRenew table tbody").createTemplater("#autoRenewTemplate"),
    $("#grdSubscriptions tr[id]").each(function()
    {
        var n = $(this);
        GetRowObj(n),
        n.children("td.sub-price").text(n.Obj.Option.Price),
        n.children("td.sub-nxt-exp").text(n.Obj.Option.Expiry)
    }),
    $("#grdSubscriptions tbody tr[id]").Sort("td.sort-selector", "#grdSubscriptions tbody", "#groupingTemplate"),
    CalculateTotal(),
    $("#grdSubscriptions tbody tr[id] td.sub-types select").change(function()
    {
        var n = $(this).parent().parent();
        GetRowObj(n),
        n.children("td.sub-price").text(n.Obj.Option.Price),
        n.children("td.sub-nxt-exp").text(n.Obj.Option.Expiry),
        n.Obj.Option.Name.indexOf("*") > -1 ? n.children("td.sub-price").addClass("pro") : n.children("td.sub-price").removeClass("pro"),
        CalculateTotal()
    }),
    $("#btnPay").click(function()
    {
        var n = [],
            t;
        $.blockUI({message: "Please wait..."}),
        $("#grdSubscriptions tbody tr[id]").each(function()
        {
            var t = $(this).children("td.sub-types").children("select").val();
            t > 0 && n.push("[" + this.id + "," + t + "]")
        }),
        n.length > 0 ? (t = PaymentScript.GetGatewayAndPaymentInfo(), PaymentScript.CallPaymentService("../SubscriptionWebService.asmx/RenewMultipleSubscriptions", '{"idsAndReplacementTypes": [' + n.join(",") + '], "paymentInfoId":' + t.PaymentInfoId + ', "gatewaySetting": ' + t.Gateway + "}", null, "Creating Subscription")) : ($.blockUI({message: "No subscriptions found to renew"}), setTimeout($.unblockUI, 3e3))
    }),
    $("#ddlPaymentGateway").change(function()
    {
        $.blockUI && $.blockUI({message: "Please wait"})
    })
})