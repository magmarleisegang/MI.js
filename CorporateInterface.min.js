function LoadReportingPage(){SetupDatepicker("#txtReport_Start",{otherCalendar:"#txtReport_End"}),SetupDatepicker("#txtReport_End",{otherCalendar:"#txtReport_Start"}),dataTemplate==undefined&&(dataTemplate=$("#dataSummaryTemplate").remove()),userTemplate=$("#users").createTemplater("#sharingUserTemplate"),driverTemplate=$("#users").createTemplater("#driverTemplate"),iLoadedCount=0,iTotalCount=parseInt($("#litTotalUserRecords").text()),$("div[data-r=gr]").length==0?$("div[data-t=gr]").css("text-decoration","line-through"):LoadSharingDetails(0),$("div[data-r=dm]").length==0?$("div[data-t=dm]").css("text-decoration","line-through"):LoadDriverDetails(0);var n=PopulateMonthSelector(new Date);$("#ddlMonthSelector").append(n.OptionArray.join(" ")),selectedMonth=$("#ddlMonthSelector").val(),$("div.view-changer div").click(function(n){n.preventDefault(),$("div.view-changer div").removeClass("selected");var t=$(this).addClass("selected").data("class");$("div#divSharingUsers div#users").removeClass("block-view table-view").addClass(t)}),$("div#divUserDetailView a[href^=can]").live("click",function(n){if(n.preventDefault(),n.stopPropagation(),confirm("Are you sure you want to cancel sharing with this person? Click OK to proceed.")){var t=$(this),i=t.attr("href").replace(/\D/g,"");DoAjax({url:"/WS/GroupReportingWebService.asmx/CancelSharing",data:'{"iRequestId":'+i+"}",successCallback:function(n){t.parents("div[class^=user-]").remove(),subscriptionCount(n.d[1]);var i=n.d[2].split(":");$("#ddlInviteSubscription").append("<option value='"+i[0]+"'>"+i[1]+"<\/option>")}})}}),$("div#divSharingUsers div.user-summary").live("click",function(n){var t=$(this);t.hasClass("table-header")||n.target.tagName=="A"||n.target.tagName=="INPUT"||t.hasClass("invite")==!1&&($("#divUserDetailView div#container div").length>1&&$("#divUserDetailView div#container div").remove(),t.clone().toggleClass("user-summary").toggleClass("user-detail").attr("id",null).appendTo("#divUserDetailView div#container"),$("div.user-detail span.edit").each(function(n,t){$(t).inlineEdit({callback:EditCallback,blurOnEnter:!0})}),$("div.user-detail span.img").click(function(){$(this).hide().prev("div.user-detail span.edit").click()}),$.blockUI({message:$("#divUserDetailView"),css:css}),$.blockUI.windowCenter())}),$("div#divSharingUsers input[type=checkbox][class=user-chk]").live("change",function(){var n=$(this);n.data("all")!=null?$("div#divSharingUsers input[type=checkbox][class=user-chk]").prop("checked",this.checked):n.data("gn")!=null?$("div#divSharingUsers input[type=checkbox][class=user-chk][data-group="+n.data("gn")+"]").prop("checked",this.checked):n.data("group")!=null&&this.checked==!1&&$("div#divSharingUsers input[type=checkbox][class=user-chk][data-gn="+n.data("group")+"], div#divSharingUsers input[type=checkbox][class=user-chk][data-all]").prop("checked",this.checked)}),$("div[data-days]").click(function(n){var i=$(this).data("days"),t;i>-1?(n.stopPropagation(),$("div.table-view div.user-summary div.data-summary div.summary[data-summary]").removeClass("tab"),$("div.table-view div.user-summary div.data-summary div.summary[data-summary="+i+"]").addClass("tab"),$("div[data-days]").removeClass("selected"),$(this).addClass("selected")):(t=$("#ddlMonthSelector").val(),t!=0&&($("#ddlMonthSelector option[value=0]").remove(),$("div[data-days]").removeClass("selected"),$(this).addClass("selected"),$("div.table-view div.user-summary div.data-summary div.summary[data-summary="+t+"]").length==0?(selectedMonth=t,iLoadedCount=0,$.blockUI({message:$("#divLoading")}),$("#spLoaded").text(iLoadedCount),LoadSharingDataSummary(selectedMonth,0),LoadDriverDataSummary(selectedMonth,0)):$("div.table-view div.user-summary div.data-summary div.summary[data-summary="+t+"]").hasClass("tab")==!1&&($("div.table-view div.user-summary div.data-summary div.summary[data-summary]").removeClass("tab"),$("div.table-view div.user-summary div.data-summary div.summary[data-summary="+t+"]").addClass("tab"))))}),$("div.actions div.report a").click(Report),$("#divReportDialog a[href=ok]").click(ReportDialogOk),$("div.user-summary div.report a, #divUserDetailView div#container div.report a").live("click",function(n){n.preventDefault(),$("div#users input[type=checkbox]").prop("checked",!1),$("div#users div#"+$(n.target).attr("href")+" div.check input[type=checkbox]").prop("checked",!0),Report(n)}),$("div.actions div.report-tabs div").click(function(){var n=$(this).data("t");$(this).toggleClass("selected"),$("div.actions div.report[data-r="+n+"]").toggle(),$("div.actions div.report[data-r!="+n+"]").hide(),$("div.actions div.report-tabs div[data-t!="+n+"]").removeClass("selected")}),$(document).click(function(n){$(n.target).data("t")==null&&($("div.actions div.report[data-r]").hide(),$("div.actions div.report-tabs div[data-t]").removeClass("selected"))})}function LoadManageGroupReporting(){subscriptionCount=function(n){if(arguments.length==0)return parseInt($("#lblOpenSlots").text());$("#lblOpenSlots").text(n)},subscriptionCount()==0&&$("div#divSharingUsers div#invite").hide(),userTemplate=$("table#grdSharedUsers tbody").createTemplater("#sharingUserTemplate"),$("#lblOpenSlots").length==0&&$("div#divGroupReportingSubscriptions a[href=i]").text("Invite More"),$("div#divGroupReportingSubscriptions a").live("click",function(n){if($(this).attr("href")=="i")n.preventDefault(),$.blockUI({message:$("#divInviteDialog")});else if($(this).attr("href")=="cancel"&&(n.preventDefault(),confirm("Are you sure you want to relinquish access to this user's business data? Click OK to proceed."))){var t=$(this),i=t.data("id");DoAjax({url:"/WS/GroupReportingWebService.asmx/CancelSharing",data:'{"iRequestId":'+i+"}",successCallback:function(n){t.parents("tr").remove(),subscriptionCount(n.d[1])}})}}),$("#divInviteDialog a[href=ok]").click(InviteUser),$("tr.sr").Sort("td.sort","table#grdSharedUsers tbody","#groupingHeaderTemplate")}function EditCallback(n){var t,r,i,u;if(n.next("div.user-detail span.img").show(),n.data("div")!=undefined)t=n.hasClass("gr")?n.data("div"):null,r=n.hasClass("dm")?n.data("div"):null,DoAjax({url:"/PrivatePages/Corporate/CorporateWebService.asmx/ChangeDivision",data:'{"iRequestId":'+t+',"iDriverId":'+r+',"newDivision":"'+n.val()+'"}',successCallback:function(n){if(n.d[0]==!0){var i=n.d[1]==null?"Not Set":n.d[1];$((t!=null?"#gr-"+t:"#dm-"+r)+" span[data-div]").text(i),$((t!=null?"#gr-"+t:"#dm-"+r)+" div.check input[data-group]").attr("data-group",i.replace(/ /g,"")),$("div#users > div.grouping").remove(),$("div#users div.user-summary").Sort("div span[data-div]","div#users","#groupingHeaderTemplate")}}});else if(n.data("rate")!=undefined){if(i=n.data("rate"),u=n.val(),/\D/g.test(u.replace(".",""))){alert("Not a valid decimal number. Please try again"),n.click();return}DoAjax({url:"/WS/GroupReportingWebService.asmx/ChangeUserRate",data:'{"iRequestId":'+i+',"newRate":'+u+"}",successCallback:function(t){if(t.d[0]==!0){$("#gr-"+i+" span[data-rate]").text(n.val());var r=t.d[1];$("#users div#gr-"+i+" div.data-summary").empty(),LoadSummaries([{DataSummaries:r,SharingRequestId:i,Rate:u}]),$("div.user-detail div.data-summary").html($("#users div#gr-"+i+" div.data-summary").html())}}})}}function LinkCloseBlockUi(n){n.preventDefault(),$.unblockUI()}function LoadSharingDetails(n){DoAjax({url:"/PrivatePages/Corporate/CorporateWebService.asmx/LoadSharingRequests",data:'{ "lastLoadedRequestId":'+n+', "pageSize": 40}',timeout:2e4,successCallback:function(n){if(n.d[0]===!1){alertUI(n.d[1]);return}if(n.d[1].length>0){var t=n.d[1];iLoadedCount+=t.length,$("#spLoaded").text(iLoadedCount),LoadPage(t,userTemplate,"div#divReportDialog div#parameters ul#requests"),iTotalCount>iLoadedCount&&LoadSharingDetails(t[t.length-1].SharingRequestId)}else $.unblockUI({fadeOut:0}),$("#divLoading").hide(),$("#divNoUsers").show()}}).then(function(){$("#divNoUsers").remove(),$("div.grouping").remove(),$("div#users div.user-summary").Sort("div span[data-div]","div#users","#groupingHeaderTemplate"),$.unblockUI({fadeOut:0}),$("#divLoading").hide(),$("div[data-days=30]").click(),($("div[data-r=gr]").length==0||$("div[data-r=dm]").length==0)&&$("div.indicate").remove()})}function LoadDriverDetails(n){DoAjax({url:"/PrivatePages/Corporate/CorporateWebService.asmx/LoadDrivers",data:'{ "lastLoadedRequestId":'+n+', "pageSize": 40}',timeout:2e4,successCallback:function(n){if(n.d[0]===!1){alertUI(n.d[1]);return}if(n.d[1].length>0){var t=n.d[1];iLoadedCount+=t.length,$("#spLoaded").text(iLoadedCount),LoadPage(t,driverTemplate,"div#divReportDialog div#parameters ul#drivers"),iTotalCount>iLoadedCount&&LoadDriverDetails(t[t.length-1].DriverId)}else $.unblockUI({fadeOut:0}),$("#divLoading").hide(),$("#divNoUsers").show()}}).then(function(){$("#divNoUsers").remove(),$("div.grouping").remove(),$("div#users div.user-summary").Sort("div span[data-div]","div#users","#groupingHeaderTemplate"),$.unblockUI({fadeOut:0}),$("#divLoading").hide(),$("div[data-days=30]").click(),($("div[data-r=gr]").length==0||$("div[data-r=dm]").length==0)&&$("div.indicate").remove()})}function LoadPage(n,t,i){for(var u=n.length,f=0,e=$(i),r=0;r<u;r++)t.add(n[r]),e.append(["<li><input type='checkbox' data-id='",n[r].RequestId!=undefined?n[r].RequestId:n[r].DriverId,"'/>",n[r].Name," ",n[r].Surname,"<\/li>"].join("")),n[r].SharingStatus!=undefined&&n[r].SharingStatus=="Requested"&&f++;LoadSummaries(n)}function LoadSummaries(n){for(var s=n.length,i,f,e,o,r,t,u=0;u<s;u++){for(i=n[u],i.SharingRequestId!=undefined?f=$("#users div#gr-"+i.SharingRequestId+" div.data-summary"):i.DriverId!=undefined&&(f=$("#users div#dm-"+i.DriverId+" div.data-summary")),e=i.DataSummaries,o=e.length,r=0;r<o;r++)t=e[r],t.Difference=(t.BusinessDistance-t.BusinessDistanceComp).toFixed(2),t.Difference>0&&(t.Difference="+"+t.Difference),t.BvP=t.BusinessDistance>0?(t.BusinessDistance/(t.BusinessDistance+t.PrivateDistance)*100).toFixed(0):0,i.Rate==undefined&&(i.Rate=0),t.Cost=(t.BusinessDistance*i.Rate).toFixed(2),t.CostDifference=(t.Cost-t.BusinessDistanceComp*i.Rate).toFixed(2),t["class"]=t.CostDifference>0?"up":"dn",t.sign=t.CostDifference>0?"u":"d",f.addOnce(dataTemplate,e[r]),kmCounter[t.NrOfDays]==undefined&&(kmCounter[t.NrOfDays]=0),kmCounter[t.NrOfDays]+=parseFloat(t.BusinessDistance);f.append("<div><\/div>")}}function LoadSharingDataSummary(n,t){DoAjax({url:"/PrivatePages/Corporate/CorporateWebService.asmx/LoadMonthlySummay_SharingRequest",data:'{"yearmonth":"'+n+'", "lastLoadedRequestId":'+t+', "pageSize": 40}',timeout:2e4,successCallback:function(t){if(t.d[0]===!1){alertUI(t.d[1]);return}if(t.d[1].length>0){var i=t.d[1];iLoadedCount+=i.length,$("#spLoaded").text(iLoadedCount),LoadMontlySummaries(i,n),iTotalCount>iLoadedCount&&LoadSharingDataSummary(n,i[i.length-1].SharingRequestId)}(t.d[1].length==0||iTotalCount>=iLoadedCount)&&($("#users div div.data-summary div[data-summary]").removeClass("tab"),$("#users div div.data-summary div[data-summary="+n+"]").addClass("tab"),$.unblockUI({fadeOut:0}),$("#divLoading").hide())}})}function LoadDriverDataSummary(n,t){DoAjax({url:"/PrivatePages/Corporate/CorporateWebService.asmx/LoadMonthlySummay_Drivers",data:'{"yearmonth":"'+n+'", "lastLoadedRequestId":'+t+', "pageSize": 40}',timeout:2e4,successCallback:function(t){if(t.d[0]===!1){alertUI(t.d[1]);return}if(t.d[1].length>0){var i=t.d[1];iLoadedCount+=i.length,$("#spLoaded").text(iLoadedCount),LoadMontlySummaries(i,n),iTotalCount>iLoadedCount&&LoadDriverDataSummary(n,i[i.length-1].DriverId)}(t.d[1].length==0||iTotalCount>=iLoadedCount)&&($("#users div div.data-summary div[data-summary]").removeClass("tab"),$("#users div div.data-summary div[data-summary="+n+"]").addClass("tab"),$.unblockUI({fadeOut:0}),$("#divLoading").hide())}})}function LoadMontlySummaries(n,t){for(var h=n.length,r,u,o,s,f,i,e=0;e<h;e++){for(r=n[e],r.SharingRequestId!=undefined?u=$("#users div#gr-"+r.SharingRequestId+" div.data-summary"):r.DriverId!=undefined&&(u=$("#users div#dm-"+r.DriverId+" div.data-summary")),u.children("div:last").hasClass()==!1&&u.children("div:last").remove(),o=r.DataSummaries,s=o.length,f=0;f<s;f++)i=o[f],i.NrOfDays=t,i.Difference=(i.BusinessDistance-i.BusinessDistanceComp).toFixed(2),i.Difference>0&&(i.Difference="+"+i.Difference),i.BvP=i.BusinessDistance>0?(i.BusinessDistance/(i.BusinessDistance+i.PrivateDistance)*100).toFixed(0):0,r.Rate==undefined&&(r.Rate=0),i.Cost=(i.BusinessDistance*r.Rate).toFixed(2),i.CostDifference=(i.Cost-i.BusinessDistanceComp*r.Rate).toFixed(2),i["class"]=i.CostDifference>0?"up":"dn",i.sign=i.CostDifference>0?"u":"d",u.addOnce(dataTemplate,o[f]),kmCounter[i.NrOfDays]==undefined&&(kmCounter[i.NrOfDays]=0),kmCounter[i.NrOfDays]+=parseFloat(i.BusinessDistance);u.append("<div><\/div>")}}function InviteUser(n){n.preventDefault();var t=$("#txtInviteUsername").val(),i=$("#txtInviteDivision").val(),r=$("#txtInviteRate").val();validEmail(t)?DoAjax({url:"/WS/GroupReportingWebService.asmx/InviteUser",data:'{"username":"'+t+'","div":"'+i+'","rate":'+r+"}",successCallback:function(n){subscriptionCount(n.d[2]),$("#lblRequestedUsers").text(parseInt($("#lblRequestedUsers").text())+1),$("#lblPendingRequests").text(parseInt($("#lblPendingRequests").text())+1),userTemplate.add(n.d[1]),$("table#grdSharedUsers tbody tr.grouping").remove(),$("tr.sr").Sort("td.sort","table#grdSharedUsers tbody","#groupingHeaderTemplate"),$("#divNoUsers").remove(),$.unblockUI()},errorCallback:function(n,t){$("#divInviteDialog p.errorBox").text(t).show()}}):$("#divInviteDialog p.errorBox").text("Invalid email address").show()}function CheckChange(n){var t=$(n.target),i=t.data("group");i==0?$("input[type=checkbox][data-group]").prop("checked",t.prop("checked")!=undefined):($("input[type=checkbox][data-group='"+i+"']").prop("checked",t.prop("checked")!=undefined),n.target.checked==!1&&$("div.grouping input[type=checkbox][data-group='0']").prop("checked",!1))}function CheckReset(n){var t=$(n.target),i=t.data("group"),r=n.target.checked;r==!1&&($("div.grouping input[type=checkbox][data-group='"+i+"']").prop("checked",!1),$("div.grouping input[type=checkbox][data-group='0']").prop("checked",!1))}function validEmail(n){return/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/gi.test(n)}function Report(n){var i,t,u,r;n.preventDefault(),i=$(n.target).data("by"),t=$(n.target).parent("div[data-r]").data("r"),$("div.actions div.report").hide(),$("div.actions div.report-tabs div").removeClass("selected"),i=="sync"?(u=[],$("div.user-summary[id^="+t+"-] div.check input:checked").length>0&&$("div.user-summary[id^="+t+"-] div.check input:checked").each(function(n,t){u.push($(t.parentNode.parentNode).attr("id").replace(/\D/g,""))}),r=['{"setCookie": false, "reportName": "'],t=="gr"?r.push('Group Reporting Sync Report", "parameters": [["iSharingRequestId", "'):r.push('Driver Summary Report", "parameters": [["iDriverId", "'),r.push(u.join(",")),r.push('"]]}'),DoAjax({url:"/ReportingWebService.asmx/RenderCorporateReport",data:r.join(""),successCallback:reportSuccessCallback},"Downloading Report")):($("div#divReportDialog div#parameters div#divReport_export input[name=exp][value='']").prop("checked",!0),i=="user"?($("div.user-summary[id="+$(n.target).attr("href")+"] div.check input").prop("checked",!0),i="list",$("#no-user-notice").hide(),t=$(n.target).attr("href").split("-")[0],$("#spReportName").text($("#divReports div[data-r="+t+"] a[data-by=list]").text())):($("#spReportName").text(n.target.innerHTML),$("#no-user-notice").css("display",$("div.user-summary[id^="+t+"-] div.check input:checked").length==0?"auto":"none")),i=[i,t],$("#divReportDialog div#parameters").removeClass().addClass(i.join(" ")),$.blockUI({message:$("#divReportDialog")}))}function ReportDialogOk(n){var i,r,u,t;n.preventDefault(),i=[],r=$("#parameters").hasClass("gr"),$("#users div[id^="+(r?"gr-":"dm-")+"] input[type=checkbox]").each(function(n,t){t.checked&&i.push($(t).parent().parent().attr("id").replace(/\D/g,""))}),u=$("#spReportName").text()+$("div#divReport_export input[type=radio][name=exp]:checked").val(),t=[],t[0]='{"setCookie":false, "reportName":"'+u+'", "parameters":',t.push('[["dtStart","'+$("#txtReport_Start").val()+'"]'),t.push(',["dtEnd","'+$("#txtReport_End").val()+'"]'),t.push(',["fShowComparison","'+$("#chkReport_SummaryComp")[0].checked+'"]'),r?t.push(',["iSharingRequestId", "'+i.join(",")+'"]'):t.push(',["iDriverId", "'+i.join(",")+'"]'),t.push("]}"),DoAjax({url:"/ReportingWebService.asmx/RenderCorporateReport",data:t.join(""),successCallback:reportSuccessCallback},"Downloading Report")}function reportSuccessCallback(n){var t,i;n.d.indexOf("ER:")==0?(t=n.d.split(":"),alert(t)):(i=siteRoot+"/PrivatePages/Reports/ReportRenderer.ashx?GUID="+n.d,document.location=i)}var userTemplate,dataTemplate,subscriptionCount,kmCounter,iLoadedCount,iTotalCount,css;(function(n){function t(n,t){var r,s,u,f,o,e,i;for(n=n.html().replace(/(^\s*)|(\s*$)/g,""),r=n.replace(/{/g,"{#").split(/[{}]{1,}/g),s=r.length,u=0;u<s;u++)r[u].indexOf("#")==0&&(f=r[u].substr(1).split("??"),o=null,f.length==2&&(o=f[1]),f[0].indexOf(":")>0?(i=f[0].split(":"),e=isNaN(i[1])===!1?t[i[0]].toFixed(parseInt(i[1])):i[1]==="trim"&&t[i[0]]!=null?t[i[0]].replace(/[ &@#$%^&*]/g,""):t[i[0]]):e=t[f[0]],r[u]=e!=null?e:o);return r.join("")}n.fn.createTemplater=function(i){return i==undefined&&(i=this.selector),this._template=n(i).remove(),this.add=function(n){var i=t(this._template,n);this.append(i)},this},n.fn.bindTemplater=function(i){return i==undefined&&(i=this.selector),this._template=n(i).clone(),this.update=function(n){var i=t(this._template,n);this.html(i)},this},n.fn.addOnce=function(n,i){var r=t(n,i);return this.append(r),this}})(jQuery),function(n){n.fn.Sort=function(t,i,r){var f=new SortBox,u;this.each(function(i,r){var u=n(r).find(t),e;u.length>0&&(e=n(r).remove(),f.Add(u.text(),e))}),u=n(i),n(f).each(function(t,i){u.addOnce(n(r),i),n(i).each(function(n,t){u.append(t)})})},SortObject=function(n){this.Group=n},SortObject.prototype=[],SortBox=function(){},SortBox.prototype=[],SortBox.constructor=SortBox,SortBox.prototype.Get=function(t){var i=null;return n(this).each(function(n,r){if(r.Group==t)return i=r,!1}),i},SortBox.prototype.Add=function(n,t){var i=this.Get(n);i==null&&(i=new SortObject(n),this.push(i)),i.push(t)}}(jQuery),function(n){n.fn.inlineEdit=function(t){function u(){var u=r.currentValue!=null?r.currentValue:(u=i.val()).length==0?i.text():u,t=document.createElement("INPUT");t.type="text",t.value=u,i.attr("class")!=undefined&&(t.className=i.attr("class")),r.useReplace?i.replaceWith(t):(i.html(t),i.unbind("click")),r.blurOnEnter===!0&&n(document).keyup(function(i){i.which==13&&n(t).blur()}),n(t).blur(e),setTimeout(function(){n(t).focus()},5)}function e(){var f=n(this),t=f.val();i.val(t).text(t),r.useReplace?f.replaceWith(i):i.html(t),i.click(u),r.callback!=null&&r.callback(i)}var r={useReplace:!0,callback:null,bindOnce:!1,blurOnEnter:!1,currentValue:null},f,i;arguments.length>0&&n.extend(r,t),f=this.parent(),i=this,r.bindOnce?u():i.click(u)}}(jQuery),kmCounter={},$(document).ready(function(){$("a[href=close]").click(LinkCloseBlockUi),$("div.cancel img").click(LinkCloseBlockUi),$("#divSharingUsers").length>0?($.blockUI({message:$("#divLoading")}),LoadReportingPage()):$("#divGroupReportingSubscriptions").length>0?LoadManageGroupReporting():$("#divLoading").hide()}),css={backgroundColor:"transparent",border:"none",position:"fixed",textAlign:"center",width:"100%",top:"0",left:"0"}