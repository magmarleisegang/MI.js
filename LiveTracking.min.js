TrackingObject=function(n,t){this.properties={distanceUnit:$("#distanceUnit").text()},this.IsRunning=!1,this.IsSelected=!1,this.JustStarted=!1,this.tr=$("#v"+this.properties.Id),this.infoWindow=new google.maps.InfoWindow,this.defaults={map:undefined,mapMarker:undefined,selectedCircle:undefined,markerColour:this.getMarkerColour(n.IsMoving,n.Speed),showMarkerLabel:!0,updateDisplayCallback:undefined},$.extend(this.properties,n),t&&$.extend(this.defaults,t),this.defaults.updateDisplayCallback&&this.IsRunning==!0&&this.defaults.updateDisplayCallback(n)},TrackingObject.prototype.Start=function(){this.defaults.map&&this.properties.Lat!=null&&this.properties.Lng!=null&&(this.updateMarker(!0),this.defaults.mapMarker.setIcon({icon:new Arrow(this.properties.HeadingDeg,this.defaults.markerColour)}),this.defaults.updateDisplayCallback&&this.defaults.updateDisplayCallback(this)),this.IsRunning=!0,this.JustStarted=!0},TrackingObject.prototype.Stop=function(){this.IsSelected=!1,this.IsRunning=!1,this.updateMarker(!1),this.infoWindow.close()},TrackingObject.prototype.Update=function(n){var i=this.JustStarted||this.properties.Lat!=n.Lat||this.properties.Lng!=n.Lng||this.properties.DateLocal!=n.DateLocal||this.properties.Speed!=n.Speed||this.properties.HeadingDeg!=n.HeadingDeg||this.properties.IsMoving!=n.IsMoving||this.properties.ConnectionProblem!=n.ConnectionProblem,r,t;return this.properties.Id==n.Id&&i&&($.extend(this.properties,n),r=this.properties.IsMoving!=n.IsMoving,t=this.getMarkerColour(n.IsMoving,n.Speed),t!=this.defaults.markerColour&&(this.defaults.markerColour=t),this.defaults.mapMarker!=undefined&&this.defaults.mapMarker.setIcon({icon:new Arrow(n.HeadingDeg,this.defaults.markerColour)}),this.setInfoWindowHtml(),this.defaults.updateDisplayCallback&&this.defaults.updateDisplayCallback(n),this.updateMarker(!0),this.IsRunning=!0,this.JustStarted=!1),this.defaults.map.getBounds().contains(this.getPosition())==!1},TrackingObject.prototype.updateMarker=function(n){var i,t;if(this.defaults.mapMarker!=undefined||n!=!1){if(this.defaults.mapMarker==undefined&&n==!0){if(this.properties.Lat==undefined||this.properties.Lng==undefined)return;i=this.getPosition(),this.defaults.mapMarker=SetupLabelMarker({map:this.defaults.map,position:i,hexColour:this.defaults.markerColour,markerletter:"",cursorString:this.defaults.showMarkerLabel?this.properties.VehicleReg:null,labelTopOffset:15,title:null}),this.defaults.mapMarker.setIcon({icon:new Arrow(0,this.defaults.markerColour)}),this.createMarkerClickListener(this.defaults.mapMarker.marker),this.createMouseOverListeners(this.defaults.mapMarker.marker),this.SetSelected(this.IsSelected);return}this.defaults.mapMarker!=undefined&&n===!0?(t=this.getPosition(),this.defaults.mapMarker.setMap(this.defaults.map),this.defaults.mapMarker.setPosition(t),this.infoWindow.setPosition(t),this.SetSelected(this.IsSelected)):n==!1&&(this.defaults.mapMarker.setMap(null),this.IsSelected=n,this.SetSelected(this.IsSelected))}},TrackingObject.prototype.createMarkerClickListener=function(n){var t=this;google.maps.event.addListener(n,"click",function(){t.tr.click()})},TrackingObject.prototype.createMouseOverListeners=function(n){var t=this;google.maps.event.addListener(n,"mouseover",function(){t.setInfoWindowHtml(),t.infoWindow.setPosition(n.getPosition()),t.infoWindow.open(t.defaults.map)}),google.maps.event.addListener(n,"mouseout",function(){t.infoWindow.close()})},TrackingObject.prototype.SetSelected=function(n){if(n===!0){if(this.defaults.mapMarker==undefined)return;this.defaults.selectedCircle!=undefined?this.defaults.selectedCircle.setOptions({map:this.defaults.map,position:this.defaults.mapMarker.marker.getPosition()}):(this.defaults.selectedCircle=new Marker(this.defaults.mapMarker.marker.getPosition(),new CircleOutline("25AAE5")),this.defaults.selectedCircle.setMap(this.defaults.map)),this.IsSelected=!0}else this.defaults.selectedCircle!=undefined&&this.defaults.selectedCircle.setMap(null),this.IsSelected=!1},TrackingObject.prototype.getPosition=function(){return new google.maps.LatLng(this.properties.Lat,this.properties.Lng)},TrackingObject.prototype.getProp=function(n){return this.properties[n]},TrackingObject.prototype.setInfoWindowHtml=function(){var n=[],t;n.push("<h3>"+this.properties.VehicleReg+"<\/h3>"),this.properties.VehicleComment&&n.push(this.properties.VehicleComment+"<br/>"),n.push("Status: "+(this.properties.IsMoving?this.properties.Speed<10?"Travelling - Stationary":"Travelling":"Not Travelling")),n.push("<br/>Last Moved: "+this.properties.DateLocal),this.properties.IsMoving&&n.push("<br/>Speed: "+this.properties.Speed+this.properties.distanceUnit+" "+this.properties.Heading),t=n.join(""),this.infoWindow.setContent(t)},TrackingObject.prototype.getMarkerColour=function(n,t){var i=parseInt(t);return n==!1?"FF0000":i<10?"FFD800":"00FF21"},TrackingObjectContainer=function(){function h(n){$.extend(t,n),this.Setup=!0}function c(n,t){i==undefined&&e(n,t)}function l(n){e(n)}function a(r){var h,o,s,c,e;if(r==undefined)for(i!=undefined&&clearTimeout(i),f&&f.abort(),fIntervalRunning=!1,o=n.length,e=0;e<o;e++)n[e].Stop();else if(r.length==undefined){for(h=u(r),n[h].Stop(),o=n.length,s=0,e=0;e<o;e++)n[e].IsRunning==!0&&(s+=1,c=e);s==1&&t.updateMapCallback?t.updateMapCallback(null,n[c].getPosition(),15):s==0&&clearTimeout(i)}}function v(t){var s,h,f,c,r,o;if(t!=undefined){if(t.length!=undefined){for(s=n.length,h=t.length,f=0;f<h;f++)for(c=t[f],r=0;r<s;r++)if(c==n[r].properties.Id){n[r].Start();break}}else if(o=u(t),o>-1)n[o].Start();else return!1;return i!=undefined&&clearTimeout(i),e(null,!0),!0}}function y(t){var f=n.length,o=0,r,u;if(t==undefined||t=="a"){for(r=0;r<f;r++)n[r].Start();o=f}else if(t=="p"||t=="t")for(r=0;r<f;r++)u=n[r],u.properties.IsMoving==(t=="t")?(u.Start(),o++):u.Stop();else return 0;return i!=undefined&&clearTimeout(i),e(null,!0),o}function p(i){if(o(),r=u(i),r==-1)return!1;n[r].SetSelected(!0),t.updateMapCallback&&t.updateMapCallback(null,n[r].getPosition(),15)}function o(){r!=-1&&(r==undefined||r==null||(n[r].SetSelected(!1),r=null))}function s(){return n.length}function w(){n=[],i=null}function u(t){var i,r,u,f,e;if(t.length!=undefined){var s=n.length,h=t.length,o=[];for(i=0;i<h;i++){for(r=t[i],u=!1,f=0;f<s;f++){n[i]!=undefined&&r==n[i].properties.Id,u=!0;break}u==!1&&o.push(r)}return o}return e=-1,$.each(n,function(n,i){if(i.properties.Id==t)return e=n,!1}),e}function e(r,o){var s,c,h;if(f!=undefined&&f.abort(),s=[],r!=undefined&&(r.length!=undefined?s=u(r):s.push(r)),c=n.length,c!=0||s.length!=0){for(h=0;h<c;h++)n[h].IsRunning&&s.push(n[h].properties.Id);s.length!=0&&(f=$.ajax({type:"POST",url:"../MappingWebService.asmx/GLBCGetDevices",contentType:"application/json; charset=utf-8",data:JSON.stringify({ids:s}),dataType:"json",success:function(r){var c,s,p,f;if(r.d[0]==!1)return alert(r.d[2]),t.updateMapCallback&&t.updateMapCallback(!1),!1;var l=r.d,h=new google.maps.LatLngBounds,a,w=l.length,b={map:t.map,showMarkerLabel:t.showMarkerLabel,updateDisplayCallback:t.updateDisplayCallback},v=null,y=!1;for(c=0;c<w;c++)s=l[c],f=u(s.Id),f!=-1?(n[f].IsSelected&&(v=n[f].getPosition()),y=n[f].Update(s)):(p=new TrackingObject(s,b),(o==undefined||o!=undefined&&o==!0)&&p.Start(),n.push(p),y=!0),h.extend(new google.maps.LatLng(s.Lat,s.Lng));w==1?(f=u(l[0].Id),a=n[f].getPosition(),h=null):v!=null&&(a=v,h=null),t.updateMapCallback&&y===!0&&t.updateMapCallback(h,a),i=setTimeout(function(){e(null,!0)},t.updateInterval)},error:function(n){n.statusText=="abort"||alert(n.responseText)},complete:function(){f=null},async:!0}))}}function b(t){var r,i;if(t!=undefined)for(r=s(),i=0;i<r;i++)t(i,n[i])}var n=[],r,f,i,t;return this.Setup=!1,t={updateInterval:5e3,map:undefined,showMarkerLabel:!0,updateDisplayCallback:undefined,updateMapCallback:undefined},{SetOptions:h,Load:c,Refresh:l,Start:v,StartMany:y,Stop:a,Count:s,Contains:u,Clear:w,SetSelected:p,ClearSelected:o,Iterate:b}}()